<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Graphing RNA Folding with Flot</title>
	<link href="flot/examples/examples.css" rel="stylesheet" type="text/css">
	<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
	<script src="flot/jquery.js"></script>
	<script src="flot/jquery.flot.js"></script>
	<script src="flot/jquery.flot.selection.js"></script>
  <script src="flot/jquery.flot.navigate.js"></script>
	<script src="flot/jquery.csv.js"></script>
  <script src="flot/jquery.flot.labels.js"></script>
</head>
<body>

  <div id="header">
    <h2>Bioflot - RNA Folding Graph</h2>
  </div>

  <!-- use width:1300px for firefox. looks okay in chrome. find a way to fix this. -->
  <div id="content">
    <hr />
    <input id="fileInput" type="file" name=files[] multiple />
    <hr />
    <br>
    <a href="secondary_structure_diagram.html">Secondary Structure Diagram</a>
    <br>
    <br>

    <div class="demo-container" style="float:left; width:300px; height:600px;">
      <div id="filebar" class="sidebar-files">
      </div>
    </div>

    <div class="demo-container" style="float:right;">
      <div id="placeholder" class="demo-placeholder" style="margin: 15px 0px 0px 15px;float:left; width:550px; height:550px"></div>
      <div id="overview" class="demo-placeholder" style="margin: 15px 15px 0px 0px;float:right; width:250px; height:250px;"></div>
      <div class="demo-item" style="float:right; width:250px; height:10px;"></div>
      <div id="displayFileNumber" class="demo-item" style="line-height:15pt; font-size:13pt;float:right; width:250px; height:40px;">Current file: none</div>
     <!-- <div style="float:right; width:250px; height:20px;"><label><input id="enableTooltip" type="checkbox"></input>Enable tooltip</label></div> -->
      <!-- <div style="float:right; width:250px; height:20px;"><label><input id="enableSquareZoom" type="checkbox" checked="checked"></input>Square Mouse Zoom</label></div> -->
      <div style="float:right; width:250px; height:20px;"><label><input id="toggleNav" type="checkbox"></input>Toggle Navigation Type</label></div>
      <div style="float:right; width:250px; height:20px;"><label><input id="toggleColor" type="checkbox"></input>Toggle Coloring</label></div>
      <div style="float:right; width:250px; height:20px;"><label><input id="toggleCompar" type="checkbox"></input>Display Comparative Model</label></div>
      <div class="demo-item" style="float:right; width:250px; height:10px;"></div>
      <div class="demo-item" style="float:right; width:250px; height:40px;"><button onclick="resetZoom()">Reset Zoom</button></div>
      <div class="demo-item" style="float:right; width:250px; height:40px;"><button onclick="reloadGraph(0)">Pick File</button></div>
      <div class="demo-item" style="float:right; width:250px; height:40px;"><button onclick="reloadGraph(1)">Previous File</button></div>
      <div class="demo-item" style="float:right; width:250px; height:40px;"><button onclick="reloadGraph(2)">Next File</button></div>
    </div>

  </div>

  <div id="footer" style="width:200px;margin:0 auto">
  </div>
  <br><br>

<script type="text/javascript">

  var organizedData = [];
  var files;
  var currentlyLoadedGraph;   // used by next/previous buttons via reloadGraph()
  var previousFile;           // used by file sidebar to reset bg color
  var xymax;
  var helixColorFormat;
  var showCompar;

  //for the larger graph
  var l_options = {
    series: {
      shadowSize: 0,
      lines: { show: true },
      points: { show: false },
      grid: { 
        hoverable: true,  //enables mouse-over events
        clickable: true,
      },
      color: "#006fff",
    },
    xaxis: { min: 0, max: 1600, ticks:12 },
    yaxis: { min: 0, max: 1600, ticks:12 },
    selection: {
              // empty because pan/zoom is enabled by default
      // mode: "xy",
      // square: true
    },
    zoom: {
      interactive: true
    },
    pan: {
      interactive: true,
      frameRate: 30
    },
  }

  //for the smaller overview graph
  var s_options = {
    series: {
      shadowSize: 0,
      lines: { show: true },
      points: { show: false },
      grid: { hoverable: false },
      color: "#006fff",
    },
    xaxis: { min: 0, max: 1600, ticks:8 },
    yaxis: { min: 0, max: 1600, ticks:8 },
    selection: {
      mode: "xy",  //for selection plugin
      square: true
    }
  }



  $(function() {
    helixColorFormat = true;
    showCompar = false;
    // prints footer
    $("#footer").prepend("Flot " + $.plot.version);

    // toggles square zoom/free zoom with click/drag zooming
    $("#enableSquareZoom").on("click", enableSquareZoom);

    // toggles between click/drag zoom and navigation
    $("#toggleNav").on("click", toggleNav);
    $("#toggleColor").on("click", function() {
      helixColorFormat = (helixColorFormat + 1) % 2;
      flotFileData(files[currentlyLoadedGraph]);
    });
    $("#toggleCompar").on("click", function() {
      showCompar = (showCompar + 1) % 2;
      flotFileData(files[currentlyLoadedGraph]);
    });
  });

  $(document).ready(function() {
    if(isAPIAvailable()) {
      $('#fileInput').bind('change', handleFileSelect);
    }
    flotTextData();


    $('#run').bind('click', flotTextData);
  });

    // displays a warning if the browser doesn't support the HTML5 File API
  function isAPIAvailable() {
    // Check for the various File API support.
    if (window.File && window.FileReader && window.FileList && window.Blob) {
      // Great success! All the File APIs are supported.
      return true;
    } else {
      alert("The browser you're using does not currently support\nthe HTML5 File API. As a result the file loading demo\nwon't work properly.");
      return false;
    }
  }

  // init for flot
  function flotTextData() {
    var fileData = [];
    bioflot = $.plot('#placeholder', fileData, l_options);
    flotmap = $.plot('#overview', fileData, s_options);

  // bind main graph for selection plugin
    $("#placeholder").bind("plotselected", function (event, ranges) {

      // clamp the zooming to prevent eternal zoom
      if (ranges.xaxis.to - ranges.xaxis.from < 0.00001) {
        ranges.xaxis.to = ranges.xaxis.from + 0.00001;
      }
      if (ranges.yaxis.to - ranges.yaxis.from < 0.00001) {
        ranges.yaxis.to = ranges.yaxis.from + 0.00001;
      }

      // do the zooming
      bioflot = $.plot("#placeholder", organizedData,
        $.extend(true, {}, l_options, {
          xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
          yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
        })
      );

      // don't fire event on the overview to prevent eternal loop
      flotmap.setSelection(ranges, true);
    });

    // this function binds selection on overview to main graph area
    $("#overview").bind("plotselected", function (event, ranges) {
      bioflot.setSelection(ranges);
    });
  }

  // allows user to reset zoom state via button
  function resetZoom() {
    bioflot = $.plot("#placeholder", organizedData,
     $.extend(true, {}, l_options, {
       xaxis: { min: -5, max: xymax },
       yaxis: { min: -5, max: xymax }
     })
    );
  }

  // toggles between pan/zoom and selection zooming on main graph
  function toggleNav() {
    if ($("#toggleNav").prop('checked')) {
      // disable pan/zoom
      l_options.zoom = {};
      l_options.pan = {};

      // enable selection zooming on main
      l_options.selection.mode = "xy";
      l_options.selection.square = true;
    }
    else {
      // disable selection zooming on main
      l_options.selection = {};
      // s_options.selection = {};  //this is for smaller graph- dont need to change it for now

      // enable pan/zoom
      l_options.zoom.interactive = true;
      l_options.pan.interactive = true;
      l_options.pan.frameRate = 30;
    }

    // update plot options
    bioflot = $.plot("#placeholder", organizedData, l_options);
    bioflot.setupGrid();
    bioflot.draw();
  }

  /* Currently Unused */
  // allows user to disable/enable square zoom feature
  function enableSquareZoom() {
    if ($("#enableSquareZoom").prop('checked')) {
      l_options.selection.square = true;
      s_options.selection.square = true;
    }
    else {
      l_options.selection.square = false;
      s_options.selection.square = false;
    }
    // update plot options
    bioflot = $.plot("#placeholder", organizedData, l_options);
    flotmap = $.plot("#overview", organizedData, s_options);

    // redraw graphs with new option settings
    bioflot.setupGrid();
    bioflot.draw();
    flotmap.setupGrid();
    flotmap.draw();
  }

  // handles csv files
  function handleFileSelect(evt) {
    files = evt.target.files; // FileList object
    // reset the flot dataset and load new file
    bioflot.setData([]);
    flotFileData(files[0]);
    currentlyLoadedGraph = 0;
    displayFiles();
    $("#file-button_0").css("background-color", "#ff6600");
    previousFile = 0;
  }

  // displays/updates currently loaded files
  function displayFiles() {
    // clear current file list
    $(".file-names").remove();

    // populate visual file list
    for (var i = 0; i <= files.length - 1; i++) { 
      $("#filebar").append('<div id="file-button_' + i + '"class="file-names">' + files[i].name + '</div>');
    };

    // load file on clicking the div/tab
    $(".file-names").click(function () {
      var name = $(this).attr("id");
      var fileNumber = name.substr(name.lastIndexOf('_') + 1);
      sidebarFileLoad(fileNumber);
    });
  }

  // load graphs based on input from file sidebar
  function sidebarFileLoad(file) {
    $("#file-button_" + previousFile).removeAttr('style');
    flotFileData(files[file]);
    currentlyLoadedGraph = file;
    $("#file-button_" + file).css("background-color", "#ff6600");
    previousFile = file;
  }

  // next/previous/file select
  function reloadGraph(n) {
    switch(n)
    {
      case 0:
      if(files == null)
        alert("Warning, no files loaded!");
      else {
        if (files.length > 1) {
        currentlyLoadedGraph = prompt("File to load (from 1 to " + (files.length) + "):") - 1;   //prompt user for input. subtract one to provide illusion of index starting at 1
        flotFileData(files[currentlyLoadedGraph]);
        sidebarFileLoad(currentlyLoadedGraph);
      }
      else
        alert("Only one file is loaded.");
    }
    break;

    case 1:
    if(files == null)
      alert("Warning, no files loaded!");
    else {
      if (files.length > 1) {
        if ((currentlyLoadedGraph - 1) >= 0) {
          currentlyLoadedGraph--;
          flotFileData(files[currentlyLoadedGraph]);
          sidebarFileLoad(currentlyLoadedGraph);
        }
        else
          alert("No previous graph to load.");
      }
      else
        alert("Only one file is loaded.");
    }
    break;

    case 2:
    if(files == null)
      alert("Warning, no files loaded!");
    else {
      if (files.length > 1) {
        if ((currentlyLoadedGraph) < files.length - 1) {
          currentlyLoadedGraph++;
          flotFileData(files[currentlyLoadedGraph]);
          sidebarFileLoad(currentlyLoadedGraph);
        }
        else
          alert("No next graph to load.");
      }
      else
        alert("Only one file is loaded.");
    }
    break;

    default:
    alert("Invalid use of reloadGraph().");
    }
  }

  function flotGraphCompar() {
    // clears graph between loading files
    organizedData = [];
    for (var j = 0; j < rawDataOriginal.length; j++) {
      organizedData.push(
        [[rawDataOriginal[j][3], rawDataOriginal[j][2]],
        [rawDataOriginal[j][4], rawDataOriginal[j][1]]
      ]);
    }

    for (var k = 0; k < rawDataOriginal.length; k++) {
      if (rawDataOriginal[k][8]) {  //if comparative == 1, draw the triangle
        for (var h = 0; h <= (rawDataOriginal[k][4] - rawDataOriginal[k][3]); h++) {
          var foldColor = "#000000";
          // if(helixColorFormat) {
          //   switch(rawDataOriginal[k][13]) {
          //     // primary initiation; yellow
          //     case 1: foldColor = "#CDCD00";
          //     break;
          //     // primary elongation; orange
          //     case 2: foldColor = "#FF9900";
          //     break;
          //     // secondary initiation; green-blue/turqoise
          //     case 3: foldColor = "#66CC99";
          //     break;
          //     // secondary elongation; blue
          //     case 4: foldColor = "#006fff";
          //     break;
          //     default: foldColor = "#000000"; //this shouldn't happen
          //   }
          // }
          // else
          //   foldColor = "#006fff";  //display missed
          organizedData.push({
            color: foldColor,
            data:
            [[(rawDataOriginal[k][1] + h), (rawDataOriginal[k][1] + h)],
            [(rawDataOriginal[k][1] + h), (rawDataOriginal[k][4] - h)],
            [(rawDataOriginal[k][4] - h), (rawDataOriginal[k][4] - h)]
          ]});
        }
      }
    }



  }

  function flotFileData(file) {
    var reader = new FileReader();
    reader.readAsText(file);
    $("#displayFileNumber").html("Current file: " + file.name);
    reader.onload = function(event){
      var csv = event.target.result;

      //newData is of form [Array[2], Array[2] ... Array[2]]
      var newData = $.csv.toArrays(csv, {
        onParseValue:$.csv.hooks.castToScalar
      });

      // detect largest x/y values for current file
      xymax = newData[newData.length-1][4] + 10;

      // reload compar graph
      organizedData = [];
      if (showCompar)
        flotGraphCompar();
      for (var j = 1; j < newData.length; j++) {
        //put [[x1,y1], [x2,y2]] into organizedData[]
        //csv: y1, y2, x2, y2

        // organizedData[j] = [[newData[j][3], newData[j][0]], [newData[j][2], newData[j][1]]];
        if(newData[j][8]) {
          organizedData.push({
            color: "#ff6600",
            data:
            [[newData[j][3], newData[j][2]],
            [newData[j][4], newData[j][1]]
            ]});
        }
        else
          organizedData.push(
            [[newData[j][3], newData[j][2]],
            [newData[j][4], newData[j][1]]
          ]);
      }

      //draw triangles
      for (var k = 0; k < newData.length; k++) {
        if (newData[k][8]) {  //if comparative == 1, draw the triangle
          for (var h = 0; h <= (newData[k][4] - newData[k][3]); h++) {
            var foldColor;
          if(helixColorFormat) {
            switch(newData[k][13]) {
              // primary initiation; yellow
              case 1: foldColor = "#CDCD00";
              break;
              // primary elongation; orange
              case 2: foldColor = "#FF9900";
              break;
              // secondary initiation; green-blue/turqoise
              case 3: foldColor = "#66CC99";
              break;
              // secondary elongation; blue
              case 4: foldColor = "#006fff";
              break;
              default: foldColor = "#000000"; //this shouldn't happen
            }
          }
            else
              foldColor = "#FF0000";
            organizedData.push({
              color: foldColor,
              data:
              [[(newData[k][1] + h), (newData[k][1] + h)],
              [(newData[k][1] + h), (newData[k][4] - h)],
              [(newData[k][4] - h), (newData[k][4] - h)]
            ]});
          }
        }
        else {
              // fold is made but not in compar model
              organizedData.push({
              color: "#66CC00",
              data:
              [[(newData[k][1] + h), (newData[k][1] + h)],
              [(newData[k][1] + h), (newData[k][4] - h)],
              [(newData[k][4] - h), (newData[k][4] - h)]
            ]});
        }
      }

      // draw diagonal line
      // should this be put first or last? last for now.
      organizedData[organizedData.length] = {
        data: [[-5000,-5000],[5000,5000]],
        color: "#555"
      };

      // append to the existing dataset
      bioflot.setData(organizedData);
      bioflot.setupGrid();
      bioflot.draw();

      flotmap.setData(organizedData);
      flotmap.setupGrid();
      flotmap.draw();
      resetZoom();
    };
    reader.onerror = function() { alert('Unable to read ' + file.fileName); };
  }

  var rawDataOriginal = [
    [0,9,13,21,25,5,7,-7.5,1,1,2,8],
    [0,27,30,553,556,4,522,-4.4,1,0,-1,37],
    [0,32,37,547,552,6,509,-11,1,0,-1,39],
    [0,39,44,398,403,6,353,-14.6,1,0,-1,61],
    [0,45,47,394,396,3,346,-6.7,1,0,-1,66],
    [0,52,54,357,359,3,302,-4.3,1,0,-1,51],
    [0,56,58,354,356,3,295,-5.5,1,0,-1,44],
    [0,61,63,104,106,3,40,-4,1,0,7,11],
    [0,66,67,102,103,2,34,-2.2,1,0,6,5],
    [0,69,70,98,99,2,27,-2.2,1,0,6,4],
    [0,73,75,95,97,3,19,-4.2,1,0,5,3],
    [0,76,82,87,93,7,4,-9.7,1,1,5,5],
    [0,113,115,312,314,3,196,-4.3,1,0,-1,52],
    [0,122,128,233,239,7,104,-14.6,1,0,-1,33],
    [0,131,132,230,231,2,97,-2.2,1,0,-1,33],
    [0,136,142,221,227,7,78,-12.4,1,0,12,34],
    [0,146,147,175,176,2,27,-3.3,1,0,10,13],
    [0,153,158,163,168,6,4,-9.1,1,1,9,5],
    [0,184,186,191,193,3,4,-4.6,1,1,10,5],
    [0,198,203,214,219,6,10,-10.3,1,0,11,11],
    [0,206,207,212,213,2,4,-3.3,1,1,11,5],
    [0,240,245,281,286,6,35,-11.4,1,0,15,6],
    [0,247,249,275,277,3,25,-5.5,1,0,15,4],
    [0,252,259,267,274,8,7,-14.6,1,1,14,8],
    [0,289,292,308,311,4,15,-7.6,1,0,16,5],
    [0,293,296,301,304,4,4,-5.9,1,1,16,5],
    [0,316,320,333,337,5,12,-9.9,1,1,17,13],
    [0,339,342,347,350,4,4,-7.8,1,1,18,5],
    [0,368,371,390,393,4,18,-7.6,1,0,20,6],
    [0,375,379,384,388,5,4,-8.5,1,1,20,5],
    [0,406,409,433,436,4,23,-4.9,1,0,23,13],
    [0,416,419,424,427,4,4,-6.3,1,1,22,5],
    [0,442,446,488,492,5,41,-12.4,1,0,25,13],
    [0,455,462,470,477,8,7,-11.9,1,1,24,8],
    [0,500,504,541,545,5,36,-11,1,0,28,20],
    [0,511,517,534,540,7,16,-13.4,1,0,27,17],
    [0,521,522,527,528,2,4,-3.4,1,1,27,5],
    [0,567,570,880,883,4,309,-9.1,1,0,-1,37],
    [0,576,580,761,765,5,180,-10.1,1,0,40,12],
    [0,584,586,755,757,3,168,-5.5,1,0,-1,22],
    [0,587,594,645,652,8,50,-11.2,1,0,33,20],
    [0,596,597,643,644,2,45,-2.1,1,0,34,15],
    [0,598,606,632,640,9,25,-14.4,1,0,32,10],
    [0,612,617,623,628,6,5,-13.4,1,1,32,6],
    [0,655,658,748,751,4,89,-6.7,1,0,-1,39],
    [0,659,662,743,746,4,80,-7,1,0,-1,30],
    [0,666,672,734,740,7,61,-17.8,1,0,-1,46],
    [0,677,684,706,713,8,21,-13.4,1,0,36,14],
    [0,688,690,697,699,3,6,-4.8,1,1,35,7],
    [0,725,726,731,732,2,4,-3.4,1,1,37,5],
    [0,769,774,805,810,6,30,-13.4,1,0,41,8],
    [0,778,779,803,804,2,23,-2.5,1,0,41,8],
    [0,783,786,796,799,4,9,-7.5,1,1,40,4],
    [0,821,826,874,879,6,47,-11.6,1,0,44,9],
    [0,827,840,846,859,14,5,-19.8,1,1,43,6],
    [0,861,862,867,868,2,4,-3.4,1,1,44,5],
    [0,884,887,910,913,4,22,-5.7,1,0,46,12],
    [0,894,897,902,905,4,4,-6.3,1,1,46,5],
    [0,921,922,1395,1396,2,472,-2.1,1,0,-1,39],
    [0,923,925,1391,1393,3,465,-3.6,1,0,-1,47],
    [0,927,933,1384,1390,7,450,-17.8,1,0,-1,43],
    [0,935,936,1379,1380,2,442,-2.2,1,0,-1,44],
    [0,938,943,1340,1345,6,396,-10.8,1,0,-1,51],
    [0,946,953,1228,1235,8,274,-14.7,1,0,-1,26],
    [0,954,955,1225,1226,2,269,-2.2,1,0,-1,41],
    [0,960,963,972,975,4,8,-5.7,1,1,49,3],
    [0,984,990,1215,1221,7,224,-15.4,1,0,-1,36],
    [0,997,998,1043,1044,2,44,-2.4,1,0,53,20],
    [0,999,1003,1037,1041,5,33,-10,1,0,53,17],
    [0,1006,1012,1017,1023,7,4,-8.7,1,1,52,5],
    [0,1027,1028,1033,1034,2,4,-3.3,1,1,52,5],
    [0,1046,1048,1209,1211,3,160,-5.4,1,0,-1,38],
    [0,1050,1053,1205,1208,4,151,-5.2,1,0,-1,35],
    [0,1056,1057,1203,1204,2,145,-2.1,1,0,-1,43],
    [0,1058,1060,1197,1199,3,136,-4.6,1,0,-1,34],
    [0,1063,1067,1189,1193,5,121,-9.1,1,0,-1,38],
    [0,1068,1073,1102,1107,6,28,-12.5,1,0,56,6],
    [0,1074,1076,1081,1083,3,4,-2.3,1,1,55,5],
    [0,1086,1089,1096,1099,4,6,-8,1,1,55,7],
    [0,1113,1117,1183,1187,5,65,-6.9,1,0,60,17],
    [0,1118,1124,1149,1155,7,24,-11.7,1,0,58,15],
    [0,1128,1129,1143,1144,2,13,-3.3,1,0,58,4],
    [0,1132,1135,1139,1142,4,3,-8.2,1,1,58,4],
    [0,1158,1159,1177,1178,2,17,-2.1,1,0,59,4],
    [0,1161,1165,1171,1175,5,5,-9.7,1,1,59,6],
    [0,1239,1247,1290,1298,9,42,-16.1,1,0,-1,34],
    [0,1253,1255,1282,1284,3,26,-4.5,1,0,65,18],
    [0,1258,1259,1276,1277,2,16,-3.4,1,0,64,17],
    [0,1263,1265,1270,1272,3,4,-4.5,1,1,64,5],
    [0,1308,1314,1323,1329,7,8,-14.5,1,1,67,9],
    [0,1350,1356,1366,1372,7,9,-12.9,1,1,69,4],
    [0,1404,1405,1496,1497,2,90,-2.4,1,0,-1,47],
    [0,1409,1412,1488,1491,4,75,-7.6,1,0,-1,32],
    [0,1414,1416,1484,1486,3,67,-1.8,1,0,-1,24],
    [0,1419,1430,1470,1481,12,39,-14.3,1,0,75,18],
    [0,1435,1440,1461,1466,6,20,-8.7,1,0,74,11],
    [0,1442,1445,1457,1460,4,11,-6,1,0,73,12],
    [0,1448,1449,1454,1455,2,4,-3.3,1,1,73,5],
    [0,1506,1515,1520,1529,10,4,-18.7,1,1,77,5]
  ]
 </script>
</body>
</html>
